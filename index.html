<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Daily System Tracker (M3 + Streaks + Firebase)</title>

  <style>
    :root{
      --bg:#0f1418;
      --surface:#141b20;
      --surface-2:#192227;
      --outline:rgba(255,255,255,.10);
      --outline-2:rgba(255,255,255,.16);

      --text:rgba(255,255,255,.92);
      --text-2:rgba(255,255,255,.72);
      --text-3:rgba(255,255,255,.56);

      --primary:#9bd1ff;
      --primary-2:#59b3ff;
      --primary-ink:#062033;

      --good:#6ee7b7;
      --warn:#fde68a;
      --bad:#fb7185;

      --radius-xl:22px;
      --radius-lg:18px;
      --radius-md:14px;

      --shadow:0 14px 40px rgba(0,0,0,.45);
      --shadow-soft:0 8px 26px rgba(0,0,0,.30);

      --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      --sans:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(155,209,255,.16), transparent 60%),
        radial-gradient(1200px 800px at 80% 0%, rgba(110,231,183,.10), transparent 60%),
        radial-gradient(900px 600px at 50% 120%, rgba(89,179,255,.10), transparent 60%),
        var(--bg);
      color:var(--text);
      line-height:1.35;
    }

    .app{max-width:1160px;margin:0 auto;padding:28px 18px 80px;display:grid;gap:16px}

    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:18px;border:1px solid var(--outline);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius:var(--radius-xl);
      box-shadow:var(--shadow-soft);
      position:sticky;top:10px;backdrop-filter:blur(10px);z-index:5;
    }

    .brand{display:flex;align-items:center;gap:12px;min-width:260px}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.55), rgba(255,255,255,.08) 46%, rgba(255,255,255,.00) 60%),
        linear-gradient(135deg, rgba(155,209,255,.95), rgba(89,179,255,.60));
      box-shadow:0 12px 24px rgba(89,179,255,.18);
      border:1px solid rgba(255,255,255,.18);
    }
    .brand h1{font-size:16px;margin:0;letter-spacing:.2px}
    .brand p{margin:2px 0 0;font-size:12px;color:var(--text-2)}

    .controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .chip{
      display:inline-flex;align-items:center;gap:8px;padding:10px 12px;
      border:1px solid var(--outline);border-radius:999px;background:rgba(255,255,255,.03);
      color:var(--text-2);font-size:12px
    }
    .chip strong{color:var(--text);font-weight:700}
    .chip .mono{font-family:var(--mono)}

    .btn{
      display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.04);
      color:var(--text);font-weight:800;cursor:pointer;
    }
    .btn:hover{border-color:rgba(255,255,255,.22);background:rgba(255,255,255,.06)}
    .btn.primary{
      background:linear-gradient(180deg, rgba(155,209,255,.95), rgba(89,179,255,.65));
      border-color:rgba(255,255,255,.22);color:var(--primary-ink);
    }
    .btn.primary:hover{filter:brightness(1.05)}
    .btn.danger{
      background:rgba(251,113,133,.12);border-color:rgba(251,113,133,.25);
      color:rgba(255,255,255,.88);
    }
    .btn.danger:hover{background:rgba(251,113,133,.16);border-color:rgba(251,113,133,.32)}
    .btn.small{padding:8px 10px;font-size:12px;font-weight:800}

    .file{display:none}

    .grid{display:grid;grid-template-columns:1.3fr .9fr;gap:16px;align-items:start}
    @media (max-width:980px){.grid{grid-template-columns:1fr}.brand{min-width:unset}}

    .card{
      border:1px solid var(--outline);
      background:rgba(255,255,255,.03);
      border-radius:var(--radius-xl);
      box-shadow:var(--shadow-soft);
      overflow:clip;
    }
    .head{
      padding:16px 16px 10px;display:flex;align-items:baseline;justify-content:space-between;gap:12px;
      border-bottom:1px solid var(--outline);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.00));
    }
    .title{margin:0;font-size:14px;letter-spacing:.2px}
    .sub{margin:0;font-size:12px;color:var(--text-2)}
    .body{padding:14px 16px 16px}
    .divider{height:1px;background:var(--outline);margin:14px 0}
   .note{
  font-size: 12px;
  color: var(--text-2);
  margin-top: 16px;     /* was 10px */
  line-height: 1.6;
  padding-top: 4px;
}
.note + .note{
  margin-top: 20px;
}


    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:620px){.row{grid-template-columns:1fr}}

    label{display:block;font-size:12px;color:var(--text-2);margin-bottom:6px}
    input[type="text"], input[type="date"], input[type="number"], textarea, select{
      width:100%;padding:12px;border-radius:14px;border:1px solid var(--outline);
      background:rgba(0,0,0,.18);color:var(--text);outline:none;
    }
    textarea{min-height:92px;resize:vertical}

    /* Fix dropdown text contrast + menu colors */
    select{color:var(--text)}
    option{
      background: #0f1418; /* dropdown panel */
      color: rgba(255,255,255,.92);
    }

    input:focus, textarea:focus, select:focus{
      border-color:rgba(155,209,255,.55);
      box-shadow:0 0 0 4px rgba(155,209,255,.12);
    }

    .kpi{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width:620px){.kpi{grid-template-columns:1fr}}
    .pill{
      padding:12px;border-radius:16px;border:1px solid var(--outline);
      background:rgba(255,255,255,.03);display:flex;flex-direction:column;gap:6px;min-height:72px;
    }
    .pill .big{font-size:16px;font-weight:900;letter-spacing:.2px}
    .pill .small{font-size:12px;color:var(--text-2)}

    .stack{display:grid;gap:10px}
    .stackhead{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .stackhead .hint{font-size:12px;color:var(--text-2)}
    .stackitem{
      display:flex;gap:10px;align-items:center;
      border:1px solid var(--outline);
      background:rgba(0,0,0,.14);
      padding:10px;border-radius:16px;
    }
    .stackitem input[type="text"]{border-radius:12px;padding:12px;border-color:rgba(255,255,255,.10)}
    .stackitem .idx{
      width:28px;height:28px;border-radius:10px;
      display:flex;align-items:center;justify-content:center;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.03);
      color:var(--text-2);
      font-family:var(--mono);
      font-size:12px;
      flex:0 0 auto;
    }

    .bars{display:grid;gap:10px}
    .bar{
      border:1px solid var(--outline);
      background:rgba(255,255,255,.02);
      border-radius:16px;padding:12px;display:grid;gap:8px;
    }
    .bar .top{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .bar .name{font-size:12px;color:var(--text-2)}
    .bar .pct{font-size:12px;color:var(--text);font-family:var(--mono)}
    .track{
      height:10px;border-radius:999px;background:rgba(255,255,255,.08);overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
    }
    .fill{
      height:100%;width:0%;border-radius:999px;
      background:linear-gradient(90deg, rgba(155,209,255,.92), rgba(89,179,255,.65));
      transition:width .25s ease;
    }
    .fill.good{background:linear-gradient(90deg, rgba(110,231,183,.92), rgba(110,231,183,.55))}
    .fill.warn{background:linear-gradient(90deg, rgba(253,230,138,.90), rgba(253,230,138,.55))}
    .fill.bad{background:linear-gradient(90deg, rgba(251,113,133,.90), rgba(251,113,133,.55))}

    /* Streak chips */
    .streaks{
      display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;
    }
.badge{
  font-size: 10px;
  padding: 6px 10px;          /* ensures breathing room */
  border-radius: 999px;
  border: 1px solid var(--outline-2);
  line-height: 1.4;           /* vertical balance */
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

.badge.primary{
  border-color: rgba(155,209,255,.35);
  color: rgba(155,209,255,.95);
  background: rgba(155,209,255,.08);
}

.badge.good{
  border-color: rgba(110,231,183,.35);
  color: rgba(110,231,183,.95);
  background: rgba(110,231,183,.08);
}

.badge.warn{
  border-color: rgba(253,230,138,.35);
  color: rgba(253,230,138,.95);
  background: rgba(253,230,138,.08);
}

.badge.bad{
  border-color: rgba(251,113,133,.35);
  color: rgba(251,113,133,.95);
  background: rgba(251,113,133,.08);
}

.badge.mono{
  font-family: var(--mono);
}


    /* Calendar */
    .calendar{display:grid;gap:10px}
    .cal-head{
      display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;
      border-radius:16px;border:1px solid var(--outline);background:rgba(255,255,255,.02);
    }
    .cal-head .month{font-weight:900;letter-spacing:.3px}
    .cal-head .hint{font-size:12px;color:var(--text-2)}
    .cal-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}

    .dow{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;padding:0 2px}
    .dow div{font-size:11px;color:var(--text-3);text-transform:uppercase;letter-spacing:.6px;padding:6px 8px}

    .gridcal{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .day{
      border:1px solid var(--outline);
      background:rgba(255,255,255,.02);
      border-radius:16px;min-height:96px;padding:10px;display:flex;flex-direction:column;gap:8px;
      cursor:pointer;
    }
    .day:hover{border-color:rgba(255,255,255,.20);background:rgba(255,255,255,.03)}
    .day.muted{opacity:.55;cursor:default}
    .day.selected{border-color:rgba(155,209,255,.55);box-shadow:0 0 0 4px rgba(155,209,255,.12)}
    .n{
      font-size:12px;color:var(--text-2);display:flex;justify-content:space-between;align-items:center;gap:8px;
      font-family:var(--mono);
    }
    .badges{display:flex;gap:6px;flex-wrap:wrap}
    .day .mini{
      font-size:12px;color:var(--text-3);
      overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;
    }

    /* Toast */
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      padding:12px 14px;border-radius:999px;border:1px solid rgba(255,255,255,.16);
      background:rgba(20,27,32,.88);backdrop-filter:blur(10px);
      color:var(--text);box-shadow:var(--shadow-soft);
      opacity:0;pointer-events:none;transition:opacity .2s ease, transform .2s ease;
      font-size:12px;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-2px)}
    .toast span{color:var(--text-2)}
  </style>
</head>

<body>
  <main class="app">
    <header class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Daily System Tracker</h1>
          <p>Unlimited Wins/Creatives • Streaks • Calendar • Firebase Sync</p>
        </div>
      </div>

      <div class="controls">
        <button class="btn" id="btnAuth" type="button">Sign in</button>

        <span class="chip">User: <strong class="mono" id="uidLabel">local</strong></span>
        <span class="chip">Selected: <strong class="mono" id="selectedLabel"></strong></span>
        <button class="btn" id="btnToday" type="button">Today</button>
        <button class="btn" id="btnExport" type="button">Export JSON</button>
        <button class="btn" id="btnImport" type="button">Import JSON</button>
        <button class="btn danger" id="btnDelete" type="button" title="Delete selected day">Delete Day</button>
        <button class="btn primary" id="btnSave" type="button">Save</button>
        <input class="file" id="importFile" type="file" accept="application/json" />
      </div>
    </header>

    <section class="grid">
      <!-- Left -->
      <div class="card">
        <div class="head">
          <div>
            <h2 class="title">Day Log</h2>
            <p class="sub">Defaults to 2 slots, but you can add as many as you want.</p>
          </div>
          <span class="chip">Targets: <strong>Wins 1–2</strong> • <strong>Creatives 1–2</strong></span>
        </div>

        <div class="body">
          <div class="kpi">
            <div class="pill">
              <div class="big">Wins</div>
              <div class="small">1–2 tangible deliverables</div>
            </div>
            <div class="pill">
              <div class="big">Creatives</div>
              <div class="small">1–2 expressive outputs</div>
            </div>
            <div class="pill">
              <div class="big">Maintenance</div>
              <div class="small">Workout + Play (time-boxed)</div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="row">
            <div>
              <label for="dateInput">Date</label>
              <input id="dateInput" type="date" />
            </div>
            <div>
              <label for="workoutMins">Workout (minutes)</label>
              <input id="workoutMins" type="number" min="0" step="5" placeholder="30" />
            </div>

            <div>
              <label for="playCount">Play sessions</label>
              <select id="playCount">
                <option value="0">0</option>
                <option value="1" selected>1</option>
                <option value="2">2</option>
              </select>
            </div>
            <div>
              <label for="mood">Energy / mood (optional)</label>
              <select id="mood">
                <option value="">—</option>
                <option value="low">Low</option>
                <option value="ok">OK</option>
                <option value="good">Good</option>
              </select>
            </div>
          </div>

          <div class="divider"></div>

          <!-- Wins dynamic -->
          <div class="stack" id="winsStack">
            <div class="stackhead">
              <div>
                <div style="font-weight:900;letter-spacing:.2px;">Wins</div>
                <div class="hint">Add more if you want, but keep daily intent small.</div>
              </div>
              <div style="display:flex;gap:8px;align-items:center;">
                <button class="btn small" id="addWin" type="button">+ Add win</button>
                <button class="btn small danger" id="clearWins" type="button">Clear</button>
              </div>
            </div>
            <div id="winsList"></div>
          </div>

          <div class="divider"></div>

          <!-- Creatives dynamic -->
          <div class="stack" id="creStack">
            <div class="stackhead">
              <div>
                <div style="font-weight:900;letter-spacing:.2px;">Creatives</div>
                <div class="hint">Output counts even if you do not post it.</div>
              </div>
              <div style="display:flex;gap:8px;align-items:center;">
                <button class="btn small" id="addCre" type="button">+ Add creative</button>
                <button class="btn small danger" id="clearCre" type="button">Clear</button>
              </div>
            </div>
            <div id="creList"></div>
          </div>

          <div class="divider"></div>

          <label for="shutdown">Shutdown note (5–10 mins)</label>
          <textarea id="shutdown" placeholder="Wins completed:
- ...

Parked for tomorrow:
- ...

Friction / blockers:
- ..."></textarea>

          <p class="note" id="syncNote">
            Saves locally. If Firebase loads successfully, it also syncs to Firestore under your anonymous user.
          </p>
        </div>
      </div>

      <!-- Right -->
      <div style="display:grid;gap:16px;">
        <div class="card">
          <div class="head">
            <div>
              <h2 class="title">Weekly Tracker + Streaks</h2>
              <p class="sub">Weekly = last 7 days. Streaks = consecutive days ending on the week anchor.</p>
            </div>
          </div>
          <div class="body">
            <div class="bars">
              <div class="bar">
                <div class="top">
                  <div class="name">Wins (count of non-empty items)</div>
                  <div class="pct" id="winsPct">0/14 • 0%</div>
                </div>
                <div class="track"><div class="fill" id="winsFill"></div></div>
              </div>

              <div class="bar">
                <div class="top">
                  <div class="name">Creatives (count of non-empty items)</div>
                  <div class="pct" id="crePct">0/14 • 0%</div>
                </div>
                <div class="track"><div class="fill" id="creFill"></div></div>
              </div>

              <div class="bar">
                <div class="top">
                  <div class="name">Workouts (days with minutes &gt; 0)</div>
                  <div class="pct" id="woPct">0/7 • 0%</div>
                </div>
                <div class="track"><div class="fill good" id="woFill"></div></div>
              </div>

              <div class="bar">
                <div class="top">
                  <div class="name">Play sessions (sum)</div>
                  <div class="pct" id="playPct">0/10 • 0%</div>
                </div>
                <div class="track"><div class="fill warn" id="playFill"></div></div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="row">
              <div>
                <label for="targetMode">Tracker targets</label>
                <select id="targetMode">
                  <option value="standard" selected>Standard (Wins/Creatives up to 14)</option>
                  <option value="minimum">Minimum (Wins/Creatives up to 7)</option>
                  <option value="aggressive">Aggressive (Wins/Creatives up to 20)</option>
                </select>
              </div>
              <div>
                <label for="weekAnchor">Week anchor (streak end)</label>
                <input id="weekAnchor" type="date" />
              </div>
            </div>

            <div class="streaks" id="streakChips"></div>

            <p class="note">
              Streak rules (ending on the anchor date):<br/>
              <span class="badge primary">Win day</span> = at least one win item.<br/>
              <span class="badge good">Creative day</span> = at least one creative item.<br/>
              <span class="badge warn">Workout day</span> = workout minutes &gt; 0.<br/>
              <span class="badge bad">Play day</span> = play sessions &gt; 0.<br/>
              <span class="badge mono">Full day</span> = Win + Creative + Workout + Play in the same day.
            </p>
          </div>
        </div>

        <div class="card">
          <div class="head">
            <div>
              <h2 class="title">Calendar</h2>
              <p class="sub">Click a day to edit. Badges show what you logged.</p>
            </div>
          </div>

          <div class="body calendar">
            <div class="cal-head">
              <div>
                <div class="month" id="monthLabel">—</div>
                <div class="hint">Month view pulls from local cache; Firebase month prefetch runs when available.</div>
              </div>

              <div class="cal-controls">
                <select id="calMonth" title="Month"></select>
                <select id="calYear" title="Year"></select>
                <button class="btn" id="btnPrev" type="button">Prev</button>
                <button class="btn" id="btnNext" type="button">Next</button>
              </div>
            </div>

            <div class="dow">
              <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
            </div>

            <div class="gridcal" id="calGrid"></div>

            <div class="note">
              Badges: <span class="badge primary">win</span> <span class="badge good">cre</span>
              <span class="badge warn">wo</span> <span class="badge bad">play</span>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="authModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); backdrop-filter:blur(6px); z-index:999;">
  <div style="max-width:520px; margin:8vh auto; padding:16px;">
    <div class="card">
      <div class="head">
        <div>
          <h2 class="title">Sign in</h2>
          <p class="sub">Use email/password. If you started anonymous, you can link and keep your data.</p>
        </div>
        <button class="btn" id="btnAuthClose" type="button">Close</button>
      </div>

      <div class="body">
        <div class="row">
          <div>
            <label for="authEmail">Email</label>
            <input id="authEmail" type="text" placeholder="you@example.com" autocomplete="email" />
          </div>
          <div>
            <label for="authPass">Password</label>
            <input id="authPass" type="text" placeholder="••••••••" autocomplete="current-password" />
          </div>
        </div>

        <div class="note">If you’re currently anonymous, press <strong>Link</strong> to attach email/password to this same account.</div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:16px;">
          <button class="btn primary" id="btnSignIn" type="button">Sign in</button>
          <button class="btn" id="btnSignUp" type="button">Sign up</button>
          <button class="btn" id="btnLink" type="button">Link</button>
          <button class="btn danger" id="btnSignOut" type="button">Sign out</button>
        </div>

        <div class="note" id="authStatus"></div>
      </div>
    </div>
  </div>
</div>


  <div class="toast" id="toast">Saved. <span id="toastHint"></span></div>

  <!-- Firebase + App (module) -->
  <script type="module">
    // ============================
    // Firebase (your config)
    // ============================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-analytics.js";

    // Firestore + Auth (needed to "push it to firebase")
    import {
      getFirestore, doc, setDoc, getDoc, deleteDoc,
      collection, query, where, getDocs
    } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    import {
  getAuth, signInAnonymously, onAuthStateChanged,
  signInWithEmailAndPassword, createUserWithEmailAndPassword,
  linkWithCredential, EmailAuthProvider, signOut
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";


    const firebaseConfig = {
      apiKey: "AIzaSyCy8gWI7Ibh9fGBrUlcEF39QozcisB0ZLo",
      authDomain: "dailyprogress-4372c.firebaseapp.com",
      projectId: "dailyprogress-4372c",
      storageBucket: "dailyprogress-4372c.firebasestorage.app",
      messagingSenderId: "1055838476577",
      appId: "1:1055838476577:web:f65804a9f1a0ecf9940660",
      measurementId: "G-ZXBM42GJK1"
    };

    const fb = {
      app: null,
      db: null,
      auth: null,
      uid: null,
      ready: false
    };

    try{
      fb.app = initializeApp(firebaseConfig);
      getAnalytics(fb.app);
      fb.db = getFirestore(fb.app);
      fb.auth = getAuth(fb.app);

// After fb.auth = getAuth(fb.app)
try {
  await setPersistence(fb.auth, browserLocalPersistence);
} catch { /* ignore */ }

let didAutoAnon = false;

onAuthStateChanged(fb.auth, async (user) => {
  if (user) {
    fb.uid = user.uid;
    fb.ready = true;

    // Display email if present, else anonymous label
    const label = user.email ? user.email : (user.isAnonymous ? "anonymous" : "user");
    document.getElementById("uidLabel").textContent = label;

    document.getElementById("syncNote").textContent =
      "Local saves + Firestore sync enabled. Export JSON for backups.";

    // Prefetch current month
    prefetchMonthFromFirestore();
    return;
  }

  // No user restored -> sign in anonymously once
  fb.uid = null;
  fb.ready = false;
  document.getElementById("uidLabel").textContent = "local";

  if (!didAutoAnon) {
    didAutoAnon = true;
    try {
      await signInAnonymously(fb.auth);
    } catch {
      // stay local only
    }
  }
});


      // Anonymous auth keeps it simple (no login UI)
      //signInAnonymously(fb.auth).catch(()=>{ /* ignore, UI will stay local-only */ });
<!-- 
      onAuthStateChanged(fb.auth, (user)=>{
        if(user){
          fb.uid = user.uid;
          fb.ready = true;
          document.getElementById("uidLabel").textContent = fb.uid.slice(0,8) + "…";
          document.getElementById("syncNote").textContent =
            "Local saves + Firestore sync enabled (anonymous user). Export JSON for backups.";
          // Prefetch current month once auth is ready
          prefetchMonthFromFirestore();
        }else{
          fb.uid = null;
          fb.ready = false;
          document.getElementById("uidLabel").textContent = "local";
        }
      }); -->
    }catch{
      // If Firebase fails, app continues locally.
      fb.ready = false;
      document.getElementById("uidLabel").textContent = "local";
    }

    // ============================
    // Local storage model
    // ============================
    const STORAGE_KEY = "daily_system_tracker_v2";
    let localDB = loadLocalDB();

    // ============================
    // DOM
    // ============================
    const dateInput = document.getElementById("dateInput");
    const selectedLabel = document.getElementById("selectedLabel");

    const workoutMins = document.getElementById("workoutMins");
    const playCount = document.getElementById("playCount");
    const mood = document.getElementById("mood");
    const shutdown = document.getElementById("shutdown");

    const winsList = document.getElementById("winsList");
    const creList = document.getElementById("creList");
    const addWin = document.getElementById("addWin");
    const clearWins = document.getElementById("clearWins");
    const addCre = document.getElementById("addCre");
    const clearCre = document.getElementById("clearCre");

    const btnSave = document.getElementById("btnSave");
    const btnToday = document.getElementById("btnToday");
    const btnDelete = document.getElementById("btnDelete");
    const btnExport = document.getElementById("btnExport");
    const btnImport = document.getElementById("btnImport");
    const importFile = document.getElementById("importFile");

    const winsPct = document.getElementById("winsPct");
    const crePct = document.getElementById("crePct");
    const woPct = document.getElementById("woPct");
    const playPct = document.getElementById("playPct");

    const winsFill = document.getElementById("winsFill");
    const creFill = document.getElementById("creFill");
    const woFill = document.getElementById("woFill");
    const playFill = document.getElementById("playFill");

    const targetMode = document.getElementById("targetMode");
    const weekAnchor = document.getElementById("weekAnchor");
    const streakChips = document.getElementById("streakChips");

    const monthLabel = document.getElementById("monthLabel");
    const calMonth = document.getElementById("calMonth");
    const calYear = document.getElementById("calYear");
    const btnPrev = document.getElementById("btnPrev");
    const btnNext = document.getElementById("btnNext");
    const calGrid = document.getElementById("calGrid");

    const toast = document.getElementById("toast");
    const toastHint = document.getElementById("toastHint");

    // ============================
    // Date helpers
    // ============================

    
    function pad2(n){ return String(n).padStart(2,"0"); }
    function toISODate(d){
      return d.getFullYear() + "-" + pad2(d.getMonth()+1) + "-" + pad2(d.getDate());
    }
    function fromISODate(s){
      const [y,m,d] = s.split("-").map(Number);
      return new Date(y, m-1, d);
    }
    function addDays(d, n){
      const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      x.setDate(x.getDate() + n);
      return x;
    }
    function startOfDay(d){ return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
    function formatHuman(s){
      const d = fromISODate(s);
      const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      return `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
    }
    function mondayIndex(d){
      const js = d.getDay(); // Sun=0..Sat=6
      return (js + 6) % 7;   // Mon=0..Sun=6
    }
    function clampInt(v, min, max){
      const n = Math.floor(Number(v));
      if(Number.isNaN(n)) return min;
      return Math.max(min, Math.min(max, n));
    }

    // ============================
    // Local DB
    // ============================
    function loadLocalDB(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(!raw) return {};
        const parsed = JSON.parse(raw);
        return (parsed && typeof parsed === "object") ? migrateDB(parsed) : {};
      }catch{
        return {};
      }
    }
    function saveLocalDB(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(localDB));
    }

    // v1 -> v2 migration (win1/win2 etc. -> arrays)
    function migrateDB(db){
      for(const [k, v] of Object.entries(db)){
        if(!v || typeof v !== "object") continue;
        if(!Array.isArray(v.wins) && (v.win1 !== undefined || v.win2 !== undefined)){
          const wins = [ (v.win1||"").trim(), (v.win2||"").trim() ].filter(Boolean);
          const creatives = [ (v.cre1||"").trim(), (v.cre2||"").trim() ].filter(Boolean);
          db[k] = {
            wins,
            creatives,
            workoutMins: Number(v.workoutMins||0),
            playCount: Number(v.playCount||0),
            mood: v.mood || "",
            shutdown: v.shutdown || "",
            date: k
          };
        }else{
          // ensure required fields
          db[k] = {
            date: k,
            wins: Array.isArray(v.wins) ? v.wins.map(s=>String(s||"")) : [],
            creatives: Array.isArray(v.creatives) ? v.creatives.map(s=>String(s||"")) : [],
            workoutMins: Number(v.workoutMins||0),
            playCount: Number(v.playCount||0),
            mood: v.mood || "",
            shutdown: v.shutdown || ""
          };
        }
      }
      return db;
    }

    function getEntry(dateStr){
      return localDB[dateStr] || {
        date: dateStr,
        wins: ["",""],        // default 2 slots
        creatives: ["",""],   // default 2 slots
        workoutMins: 0,
        playCount: 0,
        mood: "",
        shutdown: ""
      };
    }

    function setEntry(dateStr, entry){
      localDB[dateStr] = entry;
      saveLocalDB();
    }

    function deleteEntryLocal(dateStr){
      delete localDB[dateStr];
      saveLocalDB();
    }

    // ============================
    // Dynamic list UI
    // ============================
    function renderStack(listEl, items, kind){
      listEl.innerHTML = "";
      items.forEach((val, idx)=>{
        var row = document.createElement("divdiv");
        row = document.createElement("div");
        row.className = "stackitem";

        var badge = document.createElement("div");
        badge.className = "idx";
        badge.textContent = String(idx+1);

        var input = document.createElement("input");
        input.type = "text";
        input.value = val || "";
        input.placeholder = (kind === "wins")
          ? "e.g., Fix bug / ship feature / prepare launch asset"
          : "e.g., Clip draft / art mock / post draft";

        input.addEventListener("input", ()=>{
          if(kind === "wins") currentEntry.wins[idx] = input.value;
          else currentEntry.creatives[idx] = input.value;
        });

        var del = document.createElement("button");
        del.className = "btn small danger";
        del.type = "button";
        del.textContent = "Remove";
        del.addEventListener("click", ()=>{
          if(kind === "wins"){
            currentEntry.wins.splice(idx,1);
            if(currentEntry.wins.length === 0) currentEntry.wins.push("");
            renderStack(winsList, currentEntry.wins, "wins");
          }else{
            currentEntry.creatives.splice(idx,1);
            if(currentEntry.creatives.length === 0) currentEntry.creatives.push("");
            renderStack(creList, currentEntry.creatives, "cre");
          }
        });

        row.appendChild(badge);
        row.appendChild(input);
        row.appendChild(del);
        listEl.appendChild(row);
      });
    }

    // ============================
    // Current selection state
    // ============================
    let selectedDate = toISODate(new Date());
    let currentEntry = getEntry(selectedDate);

    function syncSelectedUI(){
      dateInput.value = selectedDate;
      selectedLabel.textContent = selectedDate;
      toastHint.textContent = formatHuman(selectedDate);
    }

    function loadForm(dateStr){
      currentEntry = getEntry(dateStr);

      // render dynamic lists
      if(!Array.isArray(currentEntry.wins) || currentEntry.wins.length === 0) currentEntry.wins = ["",""];
      if(!Array.isArray(currentEntry.creatives) || currentEntry.creatives.length === 0) currentEntry.creatives = ["",""];

      renderStack(winsList, currentEntry.wins, "wins");
      renderStack(creList, currentEntry.creatives, "cre");

      workoutMins.value = Number(currentEntry.workoutMins || 0);
      playCount.value = String(Number(currentEntry.playCount || 0));
      mood.value = currentEntry.mood || "";
      shutdown.value = currentEntry.shutdown || "";
    }

    function readForm(){
      // Trim but do not forcibly remove empty placeholders
      const wins = (currentEntry.wins || []).map(s => String(s || "").trim());
      const creatives = (currentEntry.creatives || []).map(s => String(s || "").trim());

      return {
        date: selectedDate,
        wins,
        creatives,
        workoutMins: clampInt(workoutMins.value, 0, 600),
        playCount: clampInt(playCount.value, 0, 12), // not limiting harshly; UI shows 0–2 but you can widen later
        mood: mood.value || "",
        shutdown: (shutdown.value || "").trim()
      };
    }

    function hasAnything(entry){
      const winAny = (entry.wins || []).some(s => (s || "").trim().length > 0);
      const creAny = (entry.creatives || []).some(s => (s || "").trim().length > 0);
      return winAny || creAny || (entry.workoutMins > 0) || (entry.playCount > 0) || entry.mood || entry.shutdown;
    }

    // ============================
    // Firebase paths (Firestore)
    // ============================
    function dayDocRef(uid, dateStr){
      // Collection layout:
      // users/{uid}/days/{YYYY-MM-DD}
      return doc(fb.db, "users", uid, "days", dateStr);
    }

    async function pushDayToFirestore(dateStr, entry){
      if(!fb.ready) return;
      const ref = dayDocRef(fb.uid, dateStr);
      // Add server-friendly fields for querying
      const payload = {
        ...entry,
        date: dateStr,
        ym: dateStr.slice(0,7),            // "YYYY-MM"
        updatedAt: Date.now()
      };
      await setDoc(ref, payload, { merge: true });
    }

    async function deleteDayFromFirestore(dateStr){
      if(!fb.ready) return;
      const ref = dayDocRef(fb.uid, dateStr);
      await deleteDoc(ref);
    }

    async function pullDayFromFirestore(dateStr){
      if(!fb.ready) return null;
      const ref = dayDocRef(fb.uid, dateStr);
      const snap = await getDoc(ref);
      if(!snap.exists()) return null;
      return snap.data();
    }

    async function prefetchMonthFromFirestore(){
      if(!fb.ready) return;
      const y = Number(calYear.value);
      const m = Number(calMonth.value) + 1;
      const ym = `${y}-${pad2(m)}`; // YYYY-MM

      try{
        const col = collection(fb.db, "users", fb.uid, "days");
        const qy = query(col, where("ym", "==", ym));
        const snap = await getDocs(qy);

        let changed = false;
        snap.forEach(docSnap=>{
          const d = docSnap.data();
          const date = d.date;
          if(date && typeof date === "string"){
            // Merge remote into local (remote wins)
            localDB[date] = migrateDB({[date]: d})[date];
            changed = true;
          }
        });

        if(changed) saveLocalDB();
        refreshAll();
      }catch{
        // ignore fetch issues, stay local
      }
    }

    // ============================
    // Save / delete actions
    // ============================
    async function saveCurrent(){
      // Sync in-memory list edits
      currentEntry.workoutMins = clampInt(workoutMins.value, 0, 600);
      currentEntry.playCount = clampInt(playCount.value, 0, 12);
      currentEntry.mood = mood.value || "";
      currentEntry.shutdown = (shutdown.value || "").trim();

      const entry = readForm();

      if(!hasAnything(entry)){
        if(localDB[selectedDate]){
          deleteEntryLocal(selectedDate);
          if(fb.ready){
            try{ await deleteDayFromFirestore(selectedDate); }catch{}
          }
          showToast("Cleared (empty day).");
        }else{
          showToast("Nothing to save.");
        }
        refreshAll();
        loadForm(selectedDate);
        return;
      }

      // Store locally
      setEntry(selectedDate, entry);

      // Push to Firestore
      if(fb.ready){
        try{
          await pushDayToFirestore(selectedDate, entry);
        }catch{
          // keep local anyway
        }
      }

      showToast("Saved.");
      refreshAll();
    }

    async function deleteCurrent(){
      if(localDB[selectedDate]){
        deleteEntryLocal(selectedDate);
        if(fb.ready){
          try{ await deleteDayFromFirestore(selectedDate); }catch{}
        }
        showToast("Deleted day.");
      }else{
        showToast("Nothing to delete.");
      }
      refreshAll();
      loadForm(selectedDate);
    }

    // ============================
    // Toast
    // ============================
    function showToast(msg){
      // toast text node is "Saved. " + span; we’ll rebuild simply
      toast.childNodes[0].textContent = msg + " ";
      toastHint.textContent = formatHuman(selectedDate);
      toast.classList.add("show");
      setTimeout(()=>toast.classList.remove("show"), 1600);
    }

    // ============================
    // Weekly tracker
    // ============================
    function getTargets(){
      const mode = targetMode.value;
      if(mode === "minimum"){
        return { winsMax: 7, creMax: 7, woMax: 7, playMax: 10 };
      }
      if(mode === "aggressive"){
        return { winsMax: 20, creMax: 20, woMax: 7, playMax: 10 };
      }
      return { winsMax: 14, creMax: 14, woMax: 7, playMax: 10 };
    }

    function countNonEmpty(arr){
      return (arr || []).reduce((acc, s)=> acc + ((String(s||"").trim().length>0) ? 1 : 0), 0);
    }

    function computeWeekly(){
      const anchor = weekAnchor.value ? fromISODate(weekAnchor.value) : new Date();
      const end = startOfDay(anchor);
      const start = addDays(end, -6);
      const targets = getTargets();

      let wins = 0, cre = 0, woDays = 0, play = 0;

      for(let i=0;i<7;i++){
        const day = addDays(start, i);
        const key = toISODate(day);
        const e = localDB[key];
        if(!e) continue;

        wins += countNonEmpty(e.wins);
        cre += countNonEmpty(e.creatives);

        const wo = Number(e.workoutMins||0);
        if(wo > 0) woDays++;

        play += Number(e.playCount||0);
      }

      setBar(wins, targets.winsMax, winsPct, winsFill);
      setBar(cre, targets.creMax, crePct, creFill);
      setBar(woDays, targets.woMax, woPct, woFill);
      setBar(play, targets.playMax, playPct, playFill);

      computeStreaks(anchor);
    }

    function setBar(value, max, labelEl, fillEl){
      const pct = max <= 0 ? 0 : Math.round((value / max) * 100);
      const clamped = Math.max(0, Math.min(100, pct));
      labelEl.textContent = `${value}/${max} • ${clamped}%`;
      fillEl.style.width = clamped + "%";
    }

    // ============================
    // Streaks (ending on anchor)
    // ============================
    function dayFlags(entry){
      const winDay = countNonEmpty(entry?.wins) > 0;
      const creDay = countNonEmpty(entry?.creatives) > 0;
      const woDay = Number(entry?.workoutMins||0) > 0;
      const playDay = Number(entry?.playCount||0) > 0;
      const fullDay = winDay && creDay && woDay && playDay;
      return { winDay, creDay, woDay, playDay, fullDay };
    }

    function streakLength(anchorDate, predicate){
      let n = 0;
      for(;;){
        const d = addDays(anchorDate, -n);
        const key = toISODate(d);
        const e = localDB[key];
        if(!e) break;
        if(!predicate(dayFlags(e), e)) break;
        n++;
      }
      return n;
    }

    function computeStreaks(anchorDate){
      const a = startOfDay(anchorDate);

      const sWin = streakLength(a, (f)=>f.winDay);
      const sCre = streakLength(a, (f)=>f.creDay);
      const sWo  = streakLength(a, (f)=>f.woDay);
      const sPlay= streakLength(a, (f)=>f.playDay);
      const sFull= streakLength(a, (f)=>f.fullDay);

      streakChips.innerHTML = `
        <span class="badge primary">Win streak: <span class="badge mono">${sWin}</span> day(s)</span>
        <span class="badge good">Creative streak: <span class="badge mono">${sCre}</span> day(s)</span>
        <span class="badge warn">Workout streak: <span class="badge mono">${sWo}</span> day(s)</span>
        <span class="badge bad">Play streak: <span class="badge mono">${sPlay}</span> day(s)</span>
        <span class="badge mono">Full streak: <span class="badge mono">${sFull}</span> day(s)</span>
      `;
    }

    // ============================
    // Calendar
    // ============================
    const monthNames = [
      "January","February","March","April","May","June",
      "July","August","September","October","November","December"
    ];

    function initMonthYearControls(){
      calMonth.innerHTML = "";
      monthNames.forEach((m, idx)=>{
        const opt = document.createElement("option");
        opt.value = String(idx);
        opt.textContent = m;
        calMonth.appendChild(opt);
      });

      const now = new Date();
      const y0 = now.getFullYear() - 5;
      const y1 = now.getFullYear() + 5;
      calYear.innerHTML = "";
      for(let y=y0; y<=y1; y++){
        const opt = document.createElement("option");
        opt.value = String(y);
        opt.textContent = String(y);
        calYear.appendChild(opt);
      }

      calMonth.value = String(now.getMonth());
      calYear.value = String(now.getFullYear());
    }

    function buildBadges(dateStr){
      const e = localDB[dateStr];
      if(!e) return { html:"", preview:"", dot:"" };

      const flags = dayFlags(e);
      const wc = countNonEmpty(e.wins);
      const cc = countNonEmpty(e.creatives);

      let html = "";
      if(flags.winDay) html += `<span class="badge primary">win ${wc}</span>`;
      if(flags.creDay) html += `<span class="badge good">cre ${cc}</span>`;
      if(flags.woDay)  html += `<span class="badge warn">wo</span>`;
      if(flags.playDay)html += `<span class="badge bad">play ${Number(e.playCount||0)}</span>`;

      const preview = (
        (e.wins || []).find(s=>String(s||"").trim()) ||
        (e.creatives || []).find(s=>String(s||"").trim()) ||
        e.shutdown || ""
      ).trim();

      return { html, preview, dot: html ? "•" : "" };
    }

    function renderCalendar(){
      const m = Number(calMonth.value);
      const y = Number(calYear.value);
      monthLabel.textContent = `${monthNames[m]} ${y}`;

      calGrid.innerHTML = "";

      const first = new Date(y, m, 1);
      const lead = mondayIndex(first);
      const gridStart = addDays(first, -lead);

      for(let i=0;i<42;i++){
        const d = addDays(gridStart, i);
        const iso = toISODate(d);
        const isInMonth = d.getMonth() === m;

        const cell = document.createElement("div");
        cell.className = "day" + (isInMonth ? "" : " muted") + (iso === selectedDate ? " selected" : "");
        cell.dataset.date = iso;

        const top = document.createElement("div");
        top.className = "n";

        const left = document.createElement("span");
        left.textContent = pad2(d.getDate());

        const right = document.createElement("span");
        const b = buildBadges(iso);
        right.textContent = b.dot;

        top.appendChild(left);
        top.appendChild(right);

        const badgesRow = document.createElement("div");
        badgesRow.className = "badges";
        badgesRow.innerHTML = b.html;

        const mini = document.createElement("div");
        mini.className = "mini";
        mini.textContent = b.preview || "";

        cell.appendChild(top);
        cell.appendChild(badgesRow);
        cell.appendChild(mini);

        if(isInMonth){
          cell.addEventListener("click", async ()=>{
            await selectDate(iso);
          });
        }
        calGrid.appendChild(cell);
      }
    }

    async function selectDate(iso){
      selectedDate = iso;
      syncSelectedUI();

      // If Firebase is ready, try pull latest for that day (fast + safe)
      if(fb.ready){
        try{
          const remote = await pullDayFromFirestore(iso);
          if(remote){
            // Merge remote -> local
            localDB[iso] = migrateDB({[iso]: remote})[iso];
            saveLocalDB();
          }
        }catch{}
      }

      loadForm(selectedDate);
      refreshAll();
    }

    // ============================
    // Export / Import
    // ============================
    function exportJSON(){
      const payload = {
        version: 2,
        exportedAt: new Date().toISOString(),
        data: localDB
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = `daily-system-tracker_${toISODate(new Date())}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      showToast("Exported.");
    }

    async function importJSONFile(file){
      const text = await file.text();
      let parsed;
      try{ parsed = JSON.parse(text); }
      catch{ showToast("Invalid JSON."); return; }

      const incoming = parsed && parsed.data && typeof parsed.data === "object" ? parsed.data : null;
      if(!incoming){ showToast("No data found."); return; }

      const merged = migrateDB(incoming);
      localDB = { ...localDB, ...merged };
      saveLocalDB();

      // Push imported data to Firestore (best-effort)
      if(fb.ready){
        const keys = Object.keys(merged);
        for(const k of keys){
          try{ await pushDayToFirestore(k, merged[k]); }catch{}
        }
      }

      showToast("Imported.");
      refreshAll();
      loadForm(selectedDate);
    }

    // ============================
    // Wiring
    // ============================
    addWin.addEventListener("click", ()=>{
      currentEntry.wins.push("");
      renderStack(winsList, currentEntry.wins, "wins");
    });
    clearWins.addEventListener("click", ()=>{
      currentEntry.wins = ["",""]; // back to default 2 slots
      renderStack(winsList, currentEntry.wins, "wins");
    });

    addCre.addEventListener("click", ()=>{
      currentEntry.creatives.push("");
      renderStack(creList, currentEntry.creatives, "cre");
    });
    clearCre.addEventListener("click", ()=>{
      currentEntry.creatives = ["",""];
      renderStack(creList, currentEntry.creatives, "cre");
    });

    btnSave.addEventListener("click", saveCurrent);
    btnDelete.addEventListener("click", deleteCurrent);

    btnToday.addEventListener("click", async ()=>{
      const today = toISODate(new Date());
      // align calendar first
      const d = new Date();
      calMonth.value = String(d.getMonth());
      calYear.value = String(d.getFullYear());
      await selectDate(today);
    });

    btnExport.addEventListener("click", exportJSON);
    btnImport.addEventListener("click", ()=> importFile.click());
    importFile.addEventListener("change", ()=>{
      const f = importFile.files && importFile.files[0];
      if(f) importJSONFile(f);
      importFile.value = "";
    });

    targetMode.addEventListener("change", computeWeekly);

    weekAnchor.addEventListener("change", ()=>{
      computeWeekly();
    });

    calMonth.addEventListener("change", ()=>{
      renderCalendar();
      if(fb.ready) prefetchMonthFromFirestore();
    });
    calYear.addEventListener("change", ()=>{
      renderCalendar();
      if(fb.ready) prefetchMonthFromFirestore();
    });

    btnPrev.addEventListener("click", ()=>{
      let m = Number(calMonth.value);
      let y = Number(calYear.value);
      m--;
      if(m < 0){ m = 11; y--; }
      calMonth.value = String(m);
      calYear.value = String(y);
      renderCalendar();
      if(fb.ready) prefetchMonthFromFirestore();
    });

    btnNext.addEventListener("click", ()=>{
      let m = Number(calMonth.value);
      let y = Number(calYear.value);
      m++;
      if(m > 11){ m = 0; y++; }
      calMonth.value = String(m);
      calYear.value = String(y);
      renderCalendar();
      if(fb.ready) prefetchMonthFromFirestore();
    });

    dateInput.addEventListener("change", async ()=>{
      const v = dateInput.value;
      if(!v) return;
      const d = fromISODate(v);
      calMonth.value = String(d.getMonth());
      calYear.value = String(d.getFullYear());
      await selectDate(v);
      renderCalendar();
      if(fb.ready) prefetchMonthFromFirestore();
    });

    // Keep these fields in sync with currentEntry
    workoutMins.addEventListener("input", ()=> currentEntry.workoutMins = clampInt(workoutMins.value, 0, 600));
    playCount.addEventListener("change", ()=> currentEntry.playCount = clampInt(playCount.value, 0, 12));
    mood.addEventListener("change", ()=> currentEntry.mood = mood.value || "");
    shutdown.addEventListener("input", ()=> currentEntry.shutdown = (shutdown.value || ""));

    // ============================
    // Refresh
    // ============================
    function refreshAll(){
      computeWeekly();
      renderCalendar();
    }

    // ============================
    // Init
    // ============================
    function init(){
      initMonthYearControls();

      const today = toISODate(new Date());
      selectedDate = today;

      weekAnchor.value = today;

      syncSelectedUI();
      loadForm(selectedDate);

      // Set calendar to current month/year
      const now = new Date();
      calMonth.value = String(now.getMonth());
      calYear.value = String(now.getFullYear());

      refreshAll();

      // Try initial month prefetch once Firebase is ready; if not ready yet, onAuthStateChanged calls it.
      if(fb.ready) prefetchMonthFromFirestore();
    }

    init();
  </script>
</body>
</html>